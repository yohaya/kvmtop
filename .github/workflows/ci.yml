name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:latest

    steps:
    - name: Install dependencies
      run: apk add --no-cache build-base git github-cli

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate Version Tag
      id: tag
      run: |
        if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
          echo "VERSION=v$(date +'%Y.%m.%d').${{ github.run_number }}-dev" >> $GITHUB_ENV
          echo "IS_DEV=true" >> $GITHUB_ENV
        else
          echo "VERSION=v$(date +'%Y.%m.%d').${{ github.run_number }}" >> $GITHUB_ENV
          echo "IS_DEV=false" >> $GITHUB_ENV
        fi

    - name: Build
      run: |
        make VERSION=${{ env.VERSION }}
        mv build/kvmtop build/kvmtop-static-linux-amd64

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kvmtop-static-linux-amd64
        path: build/kvmtop-static-linux-amd64

    - name: Release Unique Version
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push'
      with:
        tag_name: ${{ env.VERSION }}
        name: Release ${{ env.VERSION }}
        files: build/kvmtop-static-linux-amd64
        draft: false
        prerelease: ${{ env.IS_DEV == 'true' }}

    - name: Update Latest Tag (Main)
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main'
      with:
        tag_name: latest
        name: Latest Build
        files: build/kvmtop-static-linux-amd64
        draft: false
        prerelease: false
        overwrite: true

    - name: Update Latest Tag (Dev)
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/dev'
      with:
        tag_name: latest-dev
        name: Latest Dev Build
        files: build/kvmtop-static-linux-amd64
        draft: false
        prerelease: true
        overwrite: true

    - name: Commit Binary to Repo
      if: github.ref == 'refs/heads/main'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        cp build/kvmtop-static-linux-amd64 kvmtop
        git add -f kvmtop
        git commit -m "Update compiled binary [skip ci]" || echo "No changes to binary"
        git push

    - name: Cleanup Old Releases
      if: github.event_name == 'push'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get list of releases sorted by date (newest first), exclude floating tags
        releases=$(gh release list --limit 100 | grep -v "latest" | awk '{print $3}')
        
        count=0
        dev_count=0
        
        for tag in $releases; do
          if [[ "$tag" == *"-dev" ]]; then
             # Dev release
             dev_count=$((dev_count+1))
             if [ "$dev_count" -gt 3 ]; then
               echo "Deleting old dev release: $tag"
               gh release delete "$tag" --cleanup-tag -y || true
             fi
          else
             # Main release
             count=$((count+1))
             if [ "$count" -gt 3 ]; then
               echo "Deleting old main release: $tag"
               gh release delete "$tag" --cleanup-tag -y || true
             fi
          fi
        done