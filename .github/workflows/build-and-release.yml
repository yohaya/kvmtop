name: Build and Release

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'src/**'
      - 'Makefile'
      - '.github/workflows/build-and-release.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:latest

    steps:
    - name: Install dependencies
      run: apk add --no-cache build-base git github-cli

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate Version Tag
      run: |
        DATE_TAG="$(date +'%Y.%m.%d').${{ github.run_number }}"
        if [ "${{ github.ref_name }}" = "main" ]; then
          echo "VERSION=${DATE_TAG}" >> $GITHUB_ENV
          echo "IS_DEV=false" >> $GITHUB_ENV
        else
          echo "VERSION=dev-${DATE_TAG}" >> $GITHUB_ENV
          echo "IS_DEV=true" >> $GITHUB_ENV
        fi

    - name: Build
      run: |
        make VERSION=${{ env.VERSION }}
        mv build/kvmtop build/kvmtop-static-linux-amd64

    - name: Commit executable to branch
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cp build/kvmtop-static-linux-amd64 kvmtop
        chmod +x kvmtop
        git config --global --add safe.directory "$GITHUB_WORKSPACE"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
        git add -f kvmtop
        git diff --cached --quiet && echo "No changes to commit" || git commit -m "Update compiled kvmtop binary [skip ci]"
        git push origin HEAD:${{ github.ref_name }}

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kvmtop-${{ env.IS_DEV == 'true' && 'dev' || 'release' }}-build
        path: build/kvmtop-static-linux-amd64

    - name: Release Version
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: ${{ env.IS_DEV == 'true' && format('Development Build {0}', env.VERSION) || format('Release {0}', env.VERSION) }}
        body: |
          ${{ env.IS_DEV == 'true' && 'Automated development build from dev branch' || 'Release build from main branch' }}

          **Version:** ${{ env.VERSION }}
          **Commit:** ${{ github.sha }}

          ${{ env.IS_DEV == 'true' && '⚠️ This is a pre-release build from the development branch. Use at your own risk.' || '✅ Stable release from the main branch.' }}
        files: build/kvmtop-static-linux-amd64
        draft: false
        prerelease: ${{ env.IS_DEV }}

    - name: Update Latest Tag
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.IS_DEV == 'true' && 'dev-latest' || 'latest' }}
        name: ${{ env.IS_DEV == 'true' && 'Latest Development Build' || 'Latest Release' }}
        body: |
          ${{ env.IS_DEV == 'true' && 'Latest automated build from dev branch' || 'Latest stable release from main branch' }}

          **Version:** ${{ env.VERSION }}
          **Commit:** ${{ github.sha }}

          ${{ env.IS_DEV == 'true' && '⚠️ This is a rolling pre-release tag that always points to the latest dev build.' || '✅ This is a rolling tag that always points to the latest stable release.' }}
        files: build/kvmtop-static-linux-amd64
        draft: false
        prerelease: ${{ env.IS_DEV }}

    - name: Cleanup Old Releases
      if: env.IS_DEV == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get list of dev releases sorted by date (newest first), exclude 'dev-latest'
        releases=$(gh release list --exclude-drafts --limit 100 | grep "^dev-" | grep -v "dev-latest" | awk '{print $3}')

        # Keep top 5 dev releases
        count=0
        for tag in $releases; do
          count=$((count+1))
          if [ "$count" -gt 5 ]; then
            echo "Deleting old dev release: $tag"
            gh release delete "$tag" --cleanup-tag -y || true
          fi
        done
